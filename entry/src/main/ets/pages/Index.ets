import bundle from '@ohos.bundle';
import featureAbility from '@ohos.ability.featureAbility';
import UIAbility from '@ohos.app.ability.UIAbility';

import Window from '@ohos.window'
import common from '@ohos.app.ability.common';

import router from '@ohos.router';

import { EditableLeftIconType } from '@ohos.arkui.advanced.EditableTitleBar'
import http from '@ohos.net.http';

//BLE
import ble from "@ohos.bluetooth.ble"
import { BusinessError } from '@ohos.base'
import window from '@ohos.window';
interface Bed {
  BedName: string;
  PID?: number;
}
// Department è¡¨çš„æ¥å£
interface Department {
  DID: number;
  Dname?: string;
}

// MedicalOrder è¡¨çš„æ¥å£
interface MedicalOrder {
  MOID: number;
  PID?: number;
  MID?: number;
  NuringLevel?: string;
  MedicationDetails?: string;
  StartTime?: string;
  EndTime?: string;
  type?: string;
  status?: string;
}

// MedicalStaff è¡¨çš„æ¥å£
interface MedicalStaff {
  MID: number;
  DID?: number;
  Mname?: string;

}

// Doctor è¡¨çš„æ¥å£
interface Doctor {
  MID: number;
  DID?: number;
  Mname?: string;
}

// Nurse è¡¨çš„æ¥å£
interface Nurse {
  MID: number;
  DID?: number;
  Mname?: string;
  MAC?:string;
}

// Nursing è¡¨çš„æ¥å£
interface Nursing {
  MID: number;
  PID: number;
}

// Patient è¡¨çš„æ¥å£
interface Patient {
  PID: number;
  DID?: number;
  Pname?: string;
  age?: number;
  gender?: string;
  admission_date?: string; // ä½¿ç”¨ string ç±»å‹æ¥è¡¨ç¤ºæ—¥æœŸ
  illness?: string;
  allergen?: string;
}

// Treat è¡¨çš„æ¥å£
interface Treat {
  MID: number;
  PID: number;
}

interface  BleDevices{
  BedName:string;
  RSSI:number;
}


let httpRequest = http.createHttp();

const minRssi = -200//BLEä¿¡å·å¼ºåº¦

@Entry
@Component

struct Index {


  @State roomnum: number = 0
  @State roomtype: string=''
  @State bednum: string='Bed2'

  @State PDA:string=''
  @State name:string=''
  @State gender:string=''
  @State age:Number =0
  @State warning:string=''
  @State nurseName:string =''
  @State nurseID:number = 0
  @State MAC:string = ''
  @State doctor:string =''
  @State PID:Number=1
  @State responseData: string = "Loading...";

  @State Active:string="";


  @State message: string = 'Hello BLE'
  @State receivedText: string = 'No Data Received'
  @State availableDevices: Array<ble.ScanResult> = [] //èƒ½æŸ¥åˆ°çš„è®¾å¤‡
  @State Rssi:number=-200;
  @State isFullScreen:boolean = false


  aboutToAppear() {

    // let windowClass: Window.Window;
    // //è·å–ä¸Šä¸‹æ–‡
    // //var context = getContext(this) as any
    // // è·å–ä¸Šä¸‹æ–‡ï¼Œä½¿ç”¨commonæ¨¡å—
    // let context = getContext(this) as common.UIAbilityContext;
    // let promise = Window.getLastWindow(context);
    // promise.then((data) => {
    //   windowClass = data;
    //   //åˆ‡æ¢æˆæ¨ªå±
    //   let orientation = Window.Orientation.LANDSCAPE;
    //   windowClass.setPreferredOrientation(orientation, (err) => {
    //   });
    //   //this.portrait = !this.portrait
    //   //console.info('Succeeded in obtaining the top window. Data: ' + JSON.stringify(data));
    //
    // })


    this.fetchData();

    //ble.stopBLEScan()//æŠ±ç€è¯•ä¸€è¯•çš„å¿ƒæ€
    this.openBle();
    // this.stopTimer(); //
    // this.startTimer(1); // æ¯1ç§’è°ƒç”¨ä¸€æ¬¡å¼‚æ­¥å‡½æ•°
    // //this.openBle();

  }
  horVerSwitch(){
    let context = getContext(this) as common.UIAbilityContext;
    // ä½¿ç”¨getLastWindowè·å–å½“å‰çª—å£
    window.getLastWindow(context).then((lastWindow)=>{
      // ä½¿ç”¨setPreferredOrientationå®ç°æ¨ªç«–å±åˆ‡æ¢
      lastWindow.setPreferredOrientation(this.isFullScreen ? window.Orientation.PORTRAIT : window.Orientation.LANDSCAPE)
      this.isFullScreen = !this.isFullScreen
    })
  }

  private intervalId: number | null = null;
  // åˆå§‹åŒ–å®šæ—¶å™¨
  startTimer(intervalInSeconds: number) {
    this.intervalId = setInterval(async () => {
      try {
        await this.callAsyncFunction();
      } catch (error) {
        console.error("Error calling async function:", error);
      }
    }, intervalInSeconds * 1000);
  }

  // åœæ­¢å®šæ—¶å™¨
  stopTimer() {
    if (this.intervalId !== null) {
      clearInterval(this.intervalId);
      this.intervalId = null;
    }
  }

  // å¼‚æ­¥å‡½æ•°
  async callAsyncFunction() {
    //await this.fetchData();
    //this.getData(this.BleStr(this.bednum , 12));// ä½†æ˜¯ä¸šåŠ¡é€»è¾‘ä¿è¯åªæœ‰ä¸€ä¸ªrssi
    await this.openBle();

    console.log('Async function called');
  }
  //éœ€è¦åç«¯DateBaseHelper.javaæ–‡ä»¶å­˜åœ¨å¹¶è®¾ç½®å¥½æ•°æ®åº“åï¼Œè´¦æˆ·å¯†ç 
  IPstr():string//åœ¨è¿™é‡Œä¿®æ”¹IPåœ°å€
  {
    //return `http://192.168.43.215/`;
    return `http://192.168.1.5/`;
    //return `http://10.128.118.164/`;
  }
  InsertStr(tableName:string,data:string):string//åœ¨tableNameé‡Œæ’å…¥data,dataè¦æ±‚æ ¼å¼ä¸ºâ€œå±æ€§ï¼šå†…å®¹â€
  {
    return this.IPstr()+`intsert?tableName=`+tableName+`&data=`+data;
  }
  DeleteStr(tableName:string,condition:string):string//åœ¨tableNameé‡Œåˆ é™¤æ¡ä»¶ä¸ºconditionçš„æ•°æ®,conditionè¦æ±‚æ ¼å¼ä¸ºæ­£å¸¸çš„SQLæ ¼å¼ï¼ŒæŠŠ=æ¢æˆï¼š
  {
    return this.IPstr()+`delete?tableName=`+tableName+`&condition=`+condition;
  }
  UpdateStr(tableName:string,data:string,condition:string):string//åœ¨tableNameé‡ŒæŠŠæ¡ä»¶ä¸ºconditionçš„æ•°æ®æ›´æ–°ä¸ºdata,è¦æ±‚åŒä¸Š
  {
    return this.IPstr()+`update?tableName=`+tableName+`&data=`+data+`&condition=`+condition;
  }
  SelectStr(tableName:string,condition:string):string//åœ¨tableNameé‡ŒæŸ¥æ‰¾æ¡ä»¶ä¸ºconditionçš„æ•°æ®ï¼Œè¦æ±‚åŒä¸Š
  {
    return this.IPstr()+`query?tableName=`+tableName+`&condition=`+condition;
  }
  BleStr(BedName:string,RSSI:number):string//åœ¨tableNameé‡ŒæŠŠæ¡ä»¶ä¸ºconditionçš„æ•°æ®æ›´æ–°ä¸ºdata,è¦æ±‚åŒä¸Š
  {
    return this.IPstr()+`uploadRSSI?BedName=`+BedName+`&RSSI=`+RSSI;
  }


  AskStr(BedName:string)
  {
    return this.IPstr()+`askActive?BedName=`+BedName;
  }
  async ToNext()
  {

    console.log(router.getState().name);

    this.Active=await this.getData(this.AskStr(this.bednum));
    console.log("ACTIVE",this.Active)
    //console.log("router.getState().name",router.getState().name)
    console.log("this.Active==true"+this.Active.match("true"))
    console.log("router.getState().name"+(router.getState().name=="Index"))
    if((this.Active.match("true")) && (router.getState().name=="Index"))
    {
      console.log("111router.getState().name",router.getState().name)
      router.pushUrl({ url: 'pages/Page2' });

    }
    else if(this.Active.match("false") && router.getState().name=="Page2")
    {
      //router.pushUrl({ url: 'pages/Index' });
      router.back();
    }
  }


  getData(url: string): Promise<string> {//è°ƒç”¨æ–¹å¼ï¼šawait this.getData(url)è¿”å›å­—ç¬¦ä¸²ï¼Œurlæ¥è‡ªä¸Šé¢çš„å‡½æ•°è¿”å›
    return new Promise((resolve, reject) => {
      let backdata: string = "are???";
      httpRequest.request(url, (err: Error, data: http.HttpResponse) => {
        if (!err) {
          console.info('Result: ' + data.result);
          console.info(typeof(data.result));
          backdata = data.result.toString(); // ç¡®ä¿æ•°æ®ä¸ºå­—ç¬¦ä¸²ç±»å‹
          resolve(backdata); // æˆåŠŸæ—¶è§£æ Promise å¹¶è¿”å›æ•°æ®
        } else {
          console.info('error: ' + JSON.stringify(err));
          reject(err); // å¤±è´¥æ—¶æ‹’ç» Promise å¹¶è¿”å›é”™è¯¯
        }
      });
    });
  }

  async fetchData() {

    //console.log(await this.getData(url));
    try {
      console.log("dadaa"+this.SelectStr("bed", "BedName:"+this.bednum));
      const BEDData: Bed[] = JSON.parse(await this.getData(this.SelectStr("bed", "BedName:\""+this.bednum+"\"")));
      console.log("llll"+BEDData.toString());
      this.PID = BEDData[0]?.PID?.valueOf() || 0;
      console.log("PID!!"+this.PID.toString());
      const patientData: Patient[] = JSON.parse(await this.getData(this.SelectStr("patient", "PID:"+this.PID)));
      if (patientData && patientData.length > 0) {
        this.name = patientData[0]?.Pname?.toString() || '';
        this.age = patientData[0]?.age?.valueOf() || 0;
        this.gender = patientData[0]?.gender?.toString() || '';
        this.roomnum = patientData[0]?.DID?.valueOf() || 0;
        this.warning = patientData[0]?.illness?.toString() || '';
      }

      const temNurData: Nursing[] = JSON.parse(await this.getData(this.SelectStr("nursing", "PID:"+this.PID)));
      if (temNurData && temNurData.length > 0) {
        const nurseData: Nurse[] = JSON.parse(await this.getData(this.SelectStr("nurse", "MID:" + temNurData[0].MID)));
        if (nurseData && nurseData.length > 0) {
          this.nurseName = nurseData[0]?.Mname?.toString() || '';
          this.nurseID = nurseData[0]?.MID?.valueOf() || 0;
          this.MAC = nurseData[0]?.MAC?.toString() || '';
        }
      }

      const temDocData: Nursing[] = JSON.parse(await this.getData(this.SelectStr("treat", "PID:"+this.PID)));
      if (temDocData && temDocData.length > 0) {
        const doctorData: Doctor[] = JSON.parse(await this.getData(this.SelectStr("doctor", "MID:" + temDocData[0].MID)));
        if (doctorData && doctorData.length > 0) {
          this.doctor = doctorData[0]?.Mname?.toString() || '';
        }
      }

      const depData: Department[] = JSON.parse(await this.getData(this.SelectStr("department", "DID:" + patientData[0]?.DID)));
      if (depData && depData.length > 0) {
        this.roomtype = depData[0]?.Dname?.toString() || '';
      }

      //this.bednum = "Bed2";


    } catch (error) {
      console.error('Error fetching data:', error);
    }


  }


  //BLEç›¸å…³å‡½æ•°
  addData(data: ble.ScanResult): void {
    let bFind = false
    this.availableDevices.forEach(element => {
      if (!bFind && element.deviceId == data.deviceId) {
        //console.info('BLE scan update ' + data.deviceId + ' rssi:' + element.rssi + ' ==> ' + data.rssi)
        element.rssi = data.rssi
        //this.Rssi=data.rssi;
        bFind = true
      }
    })
    if (!bFind) {
      //console.info('BLE scan add ' + data.deviceId + ' count:' + this.availableDevices.length)
      this.availableDevices.push(data)//æŠŠèƒ½æŸ¥åˆ°çš„è®¾å¤‡å­˜å…¥availableDevices
      this.message = 'BLE count:' + this.availableDevices.length

      // å¤„ç†æ¥æ”¶åˆ°çš„æ•°æ®
      const allData = (data.data)
      if (allData) {
        this.receivedText = this.arrayBufferToString(allData)
      }
    }
  }
  
  arrayBufferToString(buffer: ArrayBuffer): string {
    const bytes = new Uint8Array(buffer)
    let result = ''
    for (let i = 0; i < bytes.length; i++) {
      result += String.fromCharCode(bytes[i])
    }
    return result
  }

  findMacInString(data: ArrayBuffer) : string {
    const MAC_raw = new Uint8Array(data)
    const temp:string='med'
    let MAC = ''
    for (let i = 0; i < MAC_raw.length; i++) {
      if((i+6)<MAC_raw.length && String.fromCharCode(MAC_raw[i])=='m' && String.fromCharCode(MAC_raw[i+1])=='e' && String.fromCharCode(MAC_raw[i+2])=='d')
      {
        MAC = String.fromCharCode(MAC_raw[i+3])+String.fromCharCode(MAC_raw[i+4])+String.fromCharCode(MAC_raw[i+5])+String.fromCharCode(MAC_raw[i+6])
      }
      //å¥½ä¼˜é›…çš„ä»£ç å•Šï¼ï¼ï¼
    }
    return MAC;
  }

  openBle(): void {
    console.log("MACCCCCCCCCCCCCC"+this.MAC)
    try {

      ble.on("BLEDeviceFind", (data: Array<ble.ScanResult>) => {
        let i = 0

        data.forEach(element => {
          //console.info('BLE scan device[' + i + '] deviceId = ' + element["deviceId"] +
          //' name = ' + element["deviceName"] +
          //' rssi = ' + element["rssi"] +
          //' data[' + element["data"].byteLength + '] = ' +
          //this.arrayBufferToString(element["data"]))


          if (element.rssi > minRssi && element.deviceName != '') { //è·å–æ‰€æœ‰è®¾å¤‡çš„rssi
            this.addData(element)
            //this.findMacInString(element.data) == this.MAC
            console.log("MACCCCCCCCCCCCCC" + this.MAC)
            if(this.findMacInString(element.data) == this.MAC) //å¦‚æœdataä¸­çš„MACå’Œæ­¤è®¾å¤‡æˆæƒçš„MACåŒ¹é…
            {
              console.log("keyjudge"+(this.findMacInString(element.data) == this.MAC))
              console.log("MACCCCCCCCCCCCCC" + this.MAC)
              console.log("MABBBBBBBBBBB" + this.findMacInString(element.data))
              this.getData(this.BleStr(this.bednum ,element.rssi ));// ä½†æ˜¯ä¸šåŠ¡é€»è¾‘ä¿è¯åªæœ‰ä¸€ä¸ªrssi   element.rssi
            }
            // else{
            //
            //   console.log("MABBBBBBBBBBB" + this.findMacInString(element.data))
            //   this.getData(this.BleStr(this.bednum ,-200 ));
            //
            // }
            console.log("bednum!!!!!!",this.bednum)


          }
          this.fetchData()
          this.ToNext()

          //i++
        })


      })

      ble.startBLEScan(
        null,
        {
          interval: 500,
          dutyMode: ble.ScanDuty.SCAN_MODE_LOW_POWER,
          matchMode: ble.MatchMode.MATCH_MODE_AGGRESSIVE,
        }
      )
    } catch (err) {
      // console.error("ble errCode:" + (err as BusinessError).code + ",errMessage:" + (err as BusinessError).message)
    }
  }



  getServices(code: BusinessError, gattServices: Array<ble.GattService>):void {
    if (code.code == 0) {
      let services: Array<ble.GattService> = gattServices;
      //console.log('bluetooth code is ' + code.code);
      //console.log('bluetooth services size is ', services.length);

      for (let i = 0; i < services.length; i++) {
        //console.log('bluetooth serviceUuid is ' + services[i].serviceUuid);
      }
    }
  }//'48:3F:E9:73:09:52'


aboutToDisappear(): void {
      console.log("å“ˆå“ˆ æˆ‘ç­‰ä¸åŠè¦å»æ­»è¾£")
}



  build() {

    // let orientation = bundle.DisplayOrientation.LANDSCAPE;
    // context.setDisplayOrientation(orientation, (err) => {
    //   this.portrait = !this.portrait
    //   console.info("setDisplayOrientation err: " + JSON.stringify(err));
    // });


    Column() {
      //ä¸Šè¡Œ
      Row() {

        Column() {
          Column(){ Text('ç—…æˆ¿ç±»å‹:' + this.roomtype)
  .fontSize(30)
  .fontWeight(FontWeight.Regular)
  .fontColor(Color.White)
  //.fontStyle(FontStyle.Italic)

  Text('ç—…æˆ¿å·:' + this.roomnum)
    .fontSize(30)
    .fontWeight(FontWeight.Regular)
    .fontColor(Color.White)
          }.backgroundColor(Color.Grey)


          // Button('fk u')
          //   .onClick(() => {
          //     this.horVerSwitch()
          //   }).border({ width: 2, color: Color.Black, radius: 100, style: BorderStyle.Solid })
          //   .borderRadius({ topLeft: 0 })


          //.offset({ x: '-29%', y: '0%' })//xè¡¨ç¤ºå³è¾¹åœ¨xè½´ä¸Šçš„ä½ç½®
        }
        .width('70%')
        .height('100%')
        .justifyContent(FlexAlign.Start)
        .alignItems(HorizontalAlign.Start)
        Column() {

          Column(){
            Text('PDAè¯†åˆ«\næ£€æµ‹ä¸­..')
              .fontSize(30)
              .fontWeight(FontWeight.Regular)
          }.border({ width: 2, color: Color.Black, radius: 0, style: BorderStyle.Solid })

          // Text(this.PDA)
          //   .fontSize(35)
          //   .fontWeight(FontWeight.Regular)
        }

        .justifyContent(FlexAlign.Start)
        .width('30%')
        .height('100%')
        .alignItems(HorizontalAlign.End)
        //.offset({ x: '40%', y: '0%' })//xè¡¨ç¤ºå·¦è¾¹åœ¨xè½´ä¸Šçš„ä½ç½®
        //.offset({ x: '60', y: '0%' })
      }
      .id('ä¸Šè¡Œ')

      .width('100%')
      .height('15%')
      //.backgroundColor(Color.Grey)
      .justifyContent(FlexAlign.Start)

      //.justifyContent(FlexAlign.SpaceBetween)
      //.backgroundColor(Color.Blue)

      //ä¸­è¡Œ
      Row() {

        // //ä¸­è¡Œå·¦åˆ—
        // Row() {
        //   Text(this.warning)
        //     .fontSize(30)
        //     .fontWeight(FontWeight.Regular)
        // }.width('20%')
        // .height('30%')
        // .border({ width: 2, color: Color.Black, radius: 10, style: BorderStyle.Solid })


        //Row() {
        //ä¸­è¡Œä¸­åˆ—
        Column() {

          Column() {

            Text(this.name)
              .fontSize(40)
              .fontWeight(FontWeight.Bold)
              .height('50%')
            Text(this.gender + ' ' + this.age)
              .fontSize(35)
              .fontWeight(FontWeight.Regular)
              .height('50%')


          }.width('50%')
          .height('30%')
          .border({ width: 2, color: Color.Black, radius: 10, style: BorderStyle.Solid })
          .justifyContent(FlexAlign.Center)

          Column() {
            Row() {
              Image($r('app.media.tanhao'))
                .width('15%')
              Text('æ³¨æ„äº‹é¡¹ï¼š')
                .fontSize(35)
                .fontWeight(FontWeight.Regular)


              //.fontColor(Color.Red)
            } //.width('35%')
            // .height('30%')
            // .border({ width: 2, color: Color.Black, radius: 10, style: BorderStyle.Solid })

            Shape() {  Rect().width('60%').height(5).fill("#BD3124")}//


            Row() {
              Text(this.warning)
                .fontSize(30)
                .fontWeight(FontWeight.Regular)

            }.width('80%')
            .height('60%')
            .justifyContent(FlexAlign.Center)
            .alignItems(VerticalAlign.Top)
            .padding(10)

          }.width('65%')
          .height('60%')
          .justifyContent(FlexAlign.Start)
          .border({ width: 2, color: Color.Black, radius: 10, style: BorderStyle.Solid })



        }.id('ä¸­è¡Œä¸­åˆ—')
        .width('100%')
        .height('100%')
        //.backgroundColor(Color.Yellow)
        .justifyContent(FlexAlign.SpaceBetween)


        // .markAnchor({x: '-50%', y: '-50%'})//é”šç‚¹é»˜è®¤ä¸ºå³ä¸Šè§’ï¼ï¼ï¼//ä»¥å³ä¸Šè§’ä¸ºåŸç‚¹ï¼Œå»ºç«‹æ­£å¸¸åæ ‡ç³»
        // .offset({ x: '0%', y: '-10%' })//xè¡¨ç¤ºå·¦è¾¹åœ¨xè½´ä¸Šçš„ä½ç½®//ä»¥å·¦ä¸Šè§’ä¸ºåŸç‚¹ï¼Œå‘å³ä¸ºxè½´æ­£æ–¹å‘ï¼Œå‘ä¸‹ä¸ºyè½´æ­£æ–¹å‘

        //.markAnchor({x: '-50%', y: '-50%'})
        //.offset({ x: '1%', y: '0%' })//xè¡¨ç¤ºå·¦è¾¹åœ¨xè½´ä¸Šçš„ä½ç½®


        // //ä¸­è¡Œå³åˆ—
        // Column(){
        //   Text(this.Rssi.toString())
        //     .fontSize(30)
        //     .fontWeight(FontWeight.Regular)
        //
        //
        //
        // }.width('20%')
        // .height('30%')
        // .border({ width: 2, color: Color.Black, radius: 10, style: BorderStyle.Solid })

      }.id("ä¸­è¡Œ")
      //.backgroundColor(Color.Green)
      .width('100%')
      .height('60%')
      .justifyContent(FlexAlign.SpaceEvenly)

      //ä¸‹è¡Œ
      Row(){
        //ä¸‹è¡Œå·¦åˆ—
        Row() {

          Column() {
            Row() {
              Text('ä¸»æ²»åŒ»ç”ŸğŸ‘¨ğŸ»â€âš•ï¸:')
                .fontSize(30)
                .fontWeight(FontWeight.Regular)
              //Image($r('app.media.doctor'))
                //.width('12%')
              Text(this.doctor)
                .fontSize(30)
                .fontWeight(FontWeight.Regular)
            }


            Row() {
              Text('è´Ÿè´£æŠ¤å£«ğŸ‘©ğŸ»â€âš•ï¸:')
                .fontSize(30)
                .fontWeight(FontWeight.Regular)
              //Image($r('app.media.nurse'))
                //.width('12%')
              Text(this.nurseName)
                .fontSize(30)
                .fontWeight(FontWeight.Regular)
            }
          }.justifyContent(FlexAlign.Start)


        }.id("ä¸‹è¡Œå·¦åˆ—")
        //.width('%')
        .height('60%')
        .padding(5)
        .border({ width: 2, color: Color.Black, radius: 10, style: BorderStyle.Solid })



        // Row(){
        //   //ä¸‹è¡Œå³åˆ—
        //   Column() {
        //     Row() {
        //
        //       Button('ä¸‹ä¸€é¡µ').onClick(() => { //é¡µé¢è·³è½¬
        //         router.pushUrl({ url: 'pages/Page2' })
        //       })
        //
        //     }
        //   }
        //
        // }.id('ä¸‹è¡Œå³åˆ—')
        // .width('10%')
        // .height('100%')
        // .justifyContent(FlexAlign.End)
        // .alignItems(VerticalAlign.Bottom)
        // .padding(10)
        // .backgroundColor(Color.Red)

      }.id('ä¸‹è¡Œ')
      .width('100%')
      .height('25%')
      .justifyContent(FlexAlign.Start)
      .alignItems(VerticalAlign.Bottom)
      //.backgroundColor(Color.Pink)



    }.width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)//7ECFF9FA
    .backgroundColor("#f7f6f0d3")




  }

}